<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | Blood Bank</title>
<style>
    :root {
        --primary-color: rgb(168, 22, 22);
        --secondary-color: #C70039;
        --background-light: #f4f6f8;
        --text-dark: #333;
        --border-light: #e0e0e0;
        --success-green: #388E3C;
        --alert-red: #D32F2F;
    }

    body {
        font-family: 'Inter', sans-serif;
        margin: 0;
        background: var(--background-light);
        color: var(--text-dark);
    }

    header {
        background: var(--primary-color);
        color: white;
        padding: 1.5rem 1rem;
        text-align: center;
    }

    .container {
        max-width: 1200px;
        margin: 2rem auto;
        background: white;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    h2 { 
        color: var(--primary-color);
        margin-top: 30px;
        border-bottom: 2px solid var(--border-light);
        padding-bottom: 10px;
        font-size: 1.8rem;
    }

    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin: 2rem 0;
    }

    .stat-box {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-left: 5px solid var(--secondary-color);
        transition: all 0.3s;
    }
    .stat-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .stat-box h3 { 
        color: #666; 
        margin-bottom: 0.5rem; 
        font-size: 1em; 
    }
    .stat-box p { 
        font-size: 2.5em; 
        font-weight: 700; 
        color: var(--primary-color); 
    }

    .stock-highlight { 
        border-left-color: var(--success-green); 
    }
    .stock-highlight p { 
        color: var(--success-green); 
    }

    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 1.5rem;
    }
    th, td { 
        padding: 15px 20px; 
        border-bottom: 1px solid var(--border-light); 
        text-align: left; 
    }
    th { 
        background: var(--primary-color); 
        color: white; 
        font-weight: 600; 
    }
    tr:nth-child(even) {
        background-color: #fcfcfc; 
    }
    tr:hover { 
        background: #fff7f7; 
    }
    .low-stock { 
        background-color: #ffebee !important; 
        color: var(--alert-red); 
        font-weight: 600; 
    }

    .stock-form { 
        display: flex; 
        gap: 20px; 
        margin: 30px 0; 
        padding: 25px; 
        border: 1px solid var(--border-light); 
        border-radius: 8px; 
        background: #fff; 
    }
    .stock-form > div { 
        flex-grow: 1; 
    }
    .stock-form label { 
        display: block; 
        margin-bottom: 8px; 
        font-weight: 600; 
        color: #555; 
        font-size: 0.95em; 
    }
    .stock-form select, .stock-form input[type="number"] { 
        width: 100%; 
        padding: 0.75rem; 
        border-radius: 6px; 
        border: 1px solid #ddd; 
    }

    button { 
        background: var(--primary-color); 
        color: white; 
        border: none; 
        padding: 0.8rem 1.8rem; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 1em; f
        ont-weight: 500; 
        transition: background 0.3s, transform 0.1s; 
    }
    button:hover { 
        background: var(--secondary-color); 
        transform: translateY(-1px); 
    }

    .success {
        background: #e8f5e9; 
        color: var(--success-green); 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 25px; 
        border-left: 4px solid var(--success-green); 
        font-weight: 600; 
    }
    .logout { 
        text-align: right; 
        margin-top: 40px; 
    }
    hr { border: 0; 
        height: 1px; 
        background: var(--border-light); 
        margin: 40px 0; 
    }
</style>
</head>
<body>
<header>
    <h1>Blood Bank Admin Dashboard 🩸</h1>
</header>

<div class="container">
    <h2>Dashboard Overview</h2>
    
    {% if messages %}
        {% for message in messages %}
            <div class="success">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="stats">
        <div class="stat-box">
            <h3>Total Donors</h3>
            <p>{{ total_donors }}</p>
        </div>
        <div class="stat-box">
            <h3>Available Donors</h3>
            <p>{{ available_donors }}</p>
        </div>
        <div class="stat-box">
            <h3>Total Patients</h3>
            <p>{{ total_patients }}</p>
        </div>
        <div class="stat-box stock-highlight">
            <h3>Total Blood Stock (Units)</h3>
            <p><strong>{{ total_stock_units }}</strong></p>
        </div>
    </div>

    <hr>
    <h2>Inventory Management</h2>
    <form method="POST" class="stock-form">
        {% csrf_token %}
        <div>
            <label for="{{ stock_form.blood_group.id_for_label }}">Blood Group</label>
            {{ stock_form.blood_group }}
        </div>
        <div>
            <label for="{{ stock_form.units.id_for_label }}">Units</label>
            {{ stock_form.units }}
        </div>
        <button type="submit" name="update_stock">Update Stock</button>
    </form>

    <table>
        <thead>
            <tr>
                <th>Blood Group</th>
                <th>Units in Stock</th>
            </tr>
        </thead>
        <tbody>
            {% for item in stock %}
            <tr class="{% if item.total_units < 5 %}low-stock{% endif %}">
                <td>{{ item.blood_group }}</td>
                <td>{{ item.total_units }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="2" style="text-align:center;">No stock records found.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <hr>
    <h2>Patient Records</h2>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Blood Group</th>
                <th>Phone</th>
                <th>Required Units</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in patients %}
            <tr>
                <td>{{ patient.user.username }}</td>
                <td>{{ patient.blood_group }}</td>
                <td>{{ patient.phone }}</td>
                <td>{{ patient.required_units }}</td>
                <td>{% if patient.approved %}Approved{% else %}Pending{% endif %}</td>
                <td>
                    {% if not patient.approved %}
                    <form method="POST" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="patient_id" value="{{ patient.id }}">
                        <button type="submit" name="approve_patient">Approve</button>
                    </form>
                    {% else %}
                        <button disabled style="opacity:0.5;">Approved</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <hr>
    <h2>Available bloods in Hospital</h2>
    {% if hospitals_with_stock %}
    <table>
        <tr>
            <th>Hospital Name</th>
            <th>Blood Group</th>
            <th>Available Units</th>
            <th>Address</th>
        </tr>
        {% for stock in hospitals_with_stock %}
        <tr>
            <td>{{ stock.hospital.name }}</td>
            <td>{{ stock.blood_group }}</td>
            <td>{{ stock.units }}</td>
            <td>{{ stock.hospital.address }}</td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p>No hospital has available blood at the moment.</p>
    {% endif %}
    <h2>Donor Records</h2>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Blood Group</th>
                <th>Phone</th>
            </tr>
        </thead>
        <tbody>
            {% for donor in donors %}
            <tr>
                <td>{{ donor.user.username }}</td>
                <td>{{ donor.blood_group }}</td>
                <td>{{ donor.phone }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" style="text-align:center;">No donor records found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    
    <h2>Blood Requests</h2>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Blood Group</th>
                <th>Phone</th>
                <th>Required Units</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in patients %}
            <tr>
                <td>{{ patient.user.username }}</td>
                <td>{{ patient.blood_group }}</td>
                <td>{{ patient.phone }}</td>
                <td>{{ patient.required_units }}</td>
                <td>{% if patient.approved %}Approved{% else %}Pending{% endif %}</td>
                <td>
                    {% if not patient.approved %}
                    <form method="POST" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="patient_id" value="{{ patient.id }}">
                        <button type="submit" name="approve_patient" style="padding:5px 10px; background:green; color:white; border:none; border-radius:5px;">Approve</button>
                    </form>
                    {% else %}
                        <button disabled style="opacity:0.5;">Approved</button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" style="text-align:center;">No patient records found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    
    <hr>
    <h2>Donor Health Forms</h2>
    <table>
        <thead>
            <tr>
                <th>Donor</th>
                <th>Age</th>
                <th>Weight</th>
                <th>Hemoglobin</th>
                <th>Disease</th>
                <th>Approved</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for form in health_forms %}
            <tr>
                <td>{{ form.donor.user.username }}</td>
                <td>{{ form.age }}</td>
                <td>{{ form.weight }} kg</td>
                <td>{{ form.hemoglobin_level }} g/dL</td>
                <td>{% if form.has_disease %}Yes{% else %}No{% endif %}</td>
                <td>
                    {% if form.is_approved %}
                        ✅
                    {% elif form.is_approved == False and form.submitted_at %}
                        ❌
                    {% else %}
                        Pending
                    {% endif %}
                </td>
                <td>
                    {% if form.is_approved is not True %}
                    <form method="POST" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="health_id" value="{{ form.id }}">
                        <button type="submit" name="approve_health" style="padding:5px 10px; background:green; color:white; border:none; border-radius:5px;">Approve</button>
                        <button type="submit" name="reject_health" style="padding:5px 10px; background:red; color:white; border:none; border-radius:5px;">Reject</button>
                    </form>
                    {% else %}
                        <button disabled>Approved</button>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="7" style="text-align:center;">No health forms submitted.</td></tr>
            {% endfor %}
        </tbody>
    </table>


    <div class="logout">
        <form method="POST" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit">Log Out</button>
        </form>
    </div>
</div>
</body>
</html>
